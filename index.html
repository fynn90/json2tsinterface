<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Json2TsInterface</title>
  <link rel="stylesheet" href="./assets/main.css"></link>
  <link rel="stylesheet" href="./assets/codemirror.css">
  <link rel="stylesheet" href="./assets/addon/lint.css">
  <link rel="stylesheet" href="./assets/mode/mdn-like.css">
  <link rel="stylesheet" href="./assets/mode/idea.css">
  <script src="./assets/json2tsinterface.js"></script>
  <script src="./assets/codemirror.js"></script>
  <script src="./assets/mode/javascript.js"></script>
  <script src="./assets/addon/placeholder.js"></script>
  <script src="./assets/addon/lint.js"></script>
  <script src="./assets/addon/autorefresh.js"></script>
  <script src="./assets/addon/json-lint.js"></script>
  <script src="./assets/addon/matchbrackets.js"></script>
  <script src="./assets/addon/active-line.js"></script>
  <script src="./assets/addon/closebrackets.js"></script>
  <style>
    .CodeMirror {
      height: 100%;
    }
  </style>
</head>
<body>
<div id="head">
  <h1>Json2TsInterface</h1>
  <p>å°† JSON æ•°æ®è½¬æ¢æˆ TypeScriptçš„Interface</p>
</div>
<div id="content">
  <div id="input">
    <div class="sub-head">
      <button class="conversion-btn" id="conversion">ä¸€é”®è½¬æ¢</button>
    </div>
    <div class="operate-area">
      <textarea name="input" id="input-operate" placeholder="è¯·è¾“å…¥è½¬æ¢çš„JSON"></textarea>
    </div>
  </div>
  <div id="output">
    <div class="sub-head">
      <button class="copy-btn disabled" id="copy">å¤åˆ¶æ•°æ®</button>
      <p id="copySuccessText" class="hidden">å¤åˆ¶æˆåŠŸï¼</p>
    </div>
    <div class="operate-area">
      <textarea name="input" id="output-operate" disabled placeholder=""></textarea>
    </div>
  </div>
</div>
</body>
<script>
  let conversion = document.getElementById('conversion');
  let copyBtn = document.getElementById('copy');
  let copySuccessBtn = document.getElementById('copySuccessText')
  let inputOperate = document.getElementById('input-operate');
  var inputEditor = CodeMirror.fromTextArea(inputOperate,{
    mode: 'application/json',
    tabSize: 2,
    smartIndent: true, // æ˜¯å¦æ™ºèƒ½ç¼©è¿›
    styleActiveLine: true, // å½“å‰è¡Œé«˜äº®
    lineNumbers: true, // æ˜¾ç¤ºè¡Œå·
    theme: 'mdn-like',
    gutters: ["CodeMirror-linenumbers"],
    lineWrapping: true, // è‡ªåŠ¨æ¢è¡Œ
    matchBrackets: true, // æ‹¬å·åŒ¹é…æ˜¾ç¤º
    autoCloseBrackets: true, // è¾“å…¥å’Œé€€æ ¼æ—¶æˆå¯¹
    autoRefresh: true, // è‡ªåŠ¨åˆ·æ–°
    foldOptions: {
            widget: (from, to) => {
              var count = undefined;

              // Get open / close token
              var startToken = '{', endToken = '}';
              var prevLine = window.editor_json.getLine(from.line);
              if (prevLine.lastIndexOf('[') > prevLine.lastIndexOf('{')) {
                startToken = '[', endToken = ']';
              }

              // Get json content
              var internal = window.editor_json.getRange(from, to);
              var toParse = startToken + internal + endToken;

              // Get key count
              try {
                var parsed = JSON.parse(toParse);
                count = Object.keys(parsed).length;
              } catch(e) { }

              return count ? `\u21A4${count}\u21A6` : '\u2194';
            }
          }
  });

  inputEditor.on('change',function (cm) {
    console.log(cm.getValue())
    if(!includesClass(copySuccessBtn,'disabled')) {
      copyBtn.classList.add('disabled');
    }
  })

  let outputOperate = document.getElementById('output-operate');
  var outputEditor = CodeMirror.fromTextArea(outputOperate, {
    mode: "javascript",
    lineNumbers: true,
    lineWrapping: true,
    tabSize: 2,
    smartIndent: true, // æ˜¯å¦æ™ºèƒ½ç¼©è¿›
    styleActiveLine: true, // å½“å‰è¡Œé«˜äº®
    lineNumbers: true, // æ˜¾ç¤ºè¡Œå·
    theme: 'idea',
    gutters: ["CodeMirror-linenumbers"],
    lineWrapping: true, // è‡ªåŠ¨æ¢è¡Œ
    matchBrackets: true, // æ‹¬å·åŒ¹é…æ˜¾ç¤º
    autoCloseBrackets: true, // è¾“å…¥å’Œé€€æ ¼æ—¶æˆå¯¹
    autoRefresh: true, // è‡ªåŠ¨åˆ·æ–°
    readOnly:'nocursor'
  });

  conversion.onclick = function () {
    try {
      data = JSON.parse(inputEditor.getValue());
      let interface = toInterface(data)
      console.log("ğŸš€ ~ file: index.html ~ line 103 ~ interface", interface)
      outputEditor.setValue(interface);
      copyBtn.classList.remove('disabled');
    } catch (err) {
      console.error(err);
      outputEditor.setValue(err);
    }
  }

copyBtn.addEventListener('click', async function () {
  let interface = outputEditor.getValue();
  if(!includesClass(copyBtn,'disabled')) {
    let s = await navigator.clipboard.writeText(interface);
    if(includesClass(copySuccessBtn,'hidden')) {
      copySuccessBtn.classList.remove('hidden');
      setTimeout(() => {
        copySuccessBtn.classList.add('hidden')
      }, 2500)
    }
  }

})
// åˆ¤æ–­domæ˜¯å¦å­˜åœ¨æŸä¸ª class
function includesClass(dom,className) {
  return Array.from(dom.classList).includes(className);
}
</script>
</html>
